# Docker Compose for production deployment with Traefik (Coolify)
# Domain: zvednu.cz (frontend), api.zvednu.cz (backend)
#
# Required environment variables:
#   POSTGRES_PASSWORD - Database password
#   TWILIO_AUTH_TOKEN - Twilio webhook auth token
#   TWILIO_ACCOUNT_SID - Twilio account SID (for SMS verification)
#   TWILIO_VERIFY_SERVICE_SID - Twilio Verify service SID (for SMS OTP)
#   JWT_SECRET - Secret key for JWT token signing
#   ADMIN_PHONES - Comma-separated list of admin phone numbers in E.164 format (e.g. +420123456789)
#   SENTRY_DSN - Sentry DSN for error monitoring (optional)
#   DISCORD_WEBHOOK_URL - Discord webhook for notifications (optional)
#   DEEPGRAM_API_KEY - Deepgram API key for speech-to-text
#   OPENAI_API_KEY - OpenAI API key for LLM
#   ELEVENLABS_API_KEY - ElevenLabs API key for text-to-speech
#   STRIPE_SECRET_KEY - Stripe secret key for billing
#   STRIPE_WEBHOOK_SECRET - Stripe webhook signing secret
#   STRIPE_PRICE_BASIC_MONTHLY - Stripe price ID for Basic plan (monthly)
#   STRIPE_PRICE_BASIC_ANNUAL - Stripe price ID for Basic plan (annual)
#   STRIPE_PRICE_PRO_MONTHLY - Stripe price ID for Pro plan (monthly)
#   STRIPE_PRICE_PRO_ANNUAL - Stripe price ID for Pro plan (annual)
#
# Build-time variables (set in GitHub Actions, not here):
#   VITE_HOTJAR_ID - Hotjar Site ID for analytics (baked into frontend image)
#
services:
  db:
    image: postgres:16-alpine
    container_name: karen-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: karen
      POSTGRES_USER: karen
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - karen_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U karen -d karen"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - karen-internal

  backend:
    image: ghcr.io/coollamer/karen/backend:latest
    container_name: karen-backend
    restart: unless-stopped
    environment:
      DATABASE_URL: postgres://karen:${POSTGRES_PASSWORD}@db:5432/karen?sslmode=disable
      HTTP_ADDR: :8080
      PUBLIC_BASE_URL: https://api.zvednu.cz
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID}
      TWILIO_VERIFY_SERVICE_SID: ${TWILIO_VERIFY_SERVICE_SID}
      JWT_SECRET: ${JWT_SECRET}
      SENTRY_DSN: ${SENTRY_DSN:-}
      DISCORD_WEBHOOK_URL: ${DISCORD_WEBHOOK_URL:-}
      LOG_LEVEL: info
      ADMIN_PHONES: ${ADMIN_PHONES}
      DEEPGRAM_API_KEY: ${DEEPGRAM_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      # Stripe Billing
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      STRIPE_PRICE_BASIC_MONTHLY: ${STRIPE_PRICE_BASIC_MONTHLY:-}
      STRIPE_PRICE_BASIC_ANNUAL: ${STRIPE_PRICE_BASIC_ANNUAL:-}
      STRIPE_PRICE_PRO_MONTHLY: ${STRIPE_PRICE_PRO_MONTHLY:-}
      STRIPE_PRICE_PRO_ANNUAL: ${STRIPE_PRICE_PRO_ANNUAL:-}
    depends_on:
      db:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      # Ensure Traefik routes via the external 'coolify' network.
      # Without this, Traefik may pick the internal network IP (db network) and time out.
      - "traefik.docker.network=coolify"
      # HTTPS
      - "traefik.http.routers.karen-api.rule=Host(`api.zvednu.cz`)"
      - "traefik.http.routers.karen-api.entrypoints=https"
      - "traefik.http.routers.karen-api.tls=true"
      - "traefik.http.routers.karen-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.karen-api.loadbalancer.server.port=8080"
      # HTTP redirect
      - "traefik.http.routers.karen-api-http.rule=Host(`api.zvednu.cz`)"
      - "traefik.http.routers.karen-api-http.entrypoints=http"
      - "traefik.http.routers.karen-api-http.middlewares=redirect-to-https"
    networks:
      - karen-internal
      - coolify

  frontend:
    image: ghcr.io/coollamer/karen/frontend:latest
    container_name: karen-frontend
    restart: unless-stopped
    depends_on:
      - backend
    labels:
      - "traefik.enable=true"
      # HTTPS
      - "traefik.http.routers.karen-app.rule=Host(`zvednu.cz`) || Host(`www.zvednu.cz`)"
      - "traefik.http.routers.karen-app.entrypoints=https"
      - "traefik.http.routers.karen-app.tls=true"
      - "traefik.http.routers.karen-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.karen-app.loadbalancer.server.port=80"
      # HTTP redirect
      - "traefik.http.routers.karen-app-http.rule=Host(`zvednu.cz`) || Host(`www.zvednu.cz`)"
      - "traefik.http.routers.karen-app-http.entrypoints=http"
      - "traefik.http.routers.karen-app-http.middlewares=redirect-to-https"
    networks:
      - coolify

volumes:
  karen_db_data:

networks:
  karen-internal:
  coolify:
    external: true
